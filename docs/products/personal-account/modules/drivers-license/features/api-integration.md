---
id: FEA-001-002-002
title: API Integration (Интеграция с API)
description: Интеграция с внешним сервисом API-Cloud для получения данных о ВУ
date: 2024-12-19
version: v1.0
status: draft
feature_id: drivers-license-api-integration
type: feature
module_link: ../drivers-license.md
acceptance_criteria: |
  - Автоматическое получение дополнительных данных ВУ при создании
  - Кэширование ответов API в базе данных
  - Периодическое обновление данных согласно настройкам
  - Мониторинг баланса API и отправка уведомлений
  - Корректная обработка ответов API
author: AI Analyst
---

# API Integration (Интеграция с API)

## Цель функции

Реализовать интеграцию с внешним сервисом API-Cloud для автоматического получения данных о водительских удостоверениях, обеспечивая актуальность информации и минимизацию ручного ввода данных.

## Подробное описание функционала и бизнес-логики

### Основное назначение

Функция интеграции с API обеспечивает автоматическое получение и обновление данных о водительских удостоверениях из государственных источников через сервис API-Cloud. Система кэширует полученные данные, мониторит состояние внешнего API и обеспечивает бесперебойную работу с актуальной информацией.

### Техническая интеграция

**API Endpoint:** `https://api-cloud.ru/api/gibdd.php`

**Параметры запроса:**
- `type=driver` (константа)
- `serianomer` - Серия и номер ВУ (только цифры)
- `date` - Дата выдачи (формат дд.мм.гггг)
- `token` - API ключ для аутентификации

### Логика работы

#### 1. Проверка и получение данных
**Алгоритм:**
```
1. При добавлении/проверке ВУ:
   - Поиск записи в локальной базе по номеру и дате
   - Проверка актуальности согласно настройкам (default: 7 дней)
   - Если данные устарели или отсутствуют -> запрос к API
2. Выполнение API запроса:
   - Формирование запроса с валидными параметрами
   - Отправка HTTP запроса к API-Cloud
   - Обработка ответа и извлечение данных
3. Обновление локальных данных:
   - Сохранение полученных данных в базе
   - Обновление timestamp последней проверки
   - Логирование операции
```

#### 2. Кэширование данных
**Стратегия кэширования:**
- **Полное сохранение:** Все ответы API сохраняются в базе данных
- **Временные метки:** Каждая запись содержит дату последнего обновления
- **Настраиваемая актуальность:** Период обновления настраивается администратором
- **Инкрементальное обновление:** Обновляются только устаревшие записи

#### 3. Мониторинг состояния API

**Контроль баланса:**
- Отслеживание текущего баланса при каждом запросе
- Автоматическое уведомление на `a.ivanov@cargonomica.com` при балансе < 10000 руб.
- Блокировка запросов при критически низком балансе

**Статистика использования:**
- Количество запросов за период
- Средняя стоимость запроса
- Время ответа API
- Частота ошибок

### Структура данных

#### Ответ API-Cloud:
```json
{
  "doc": {
    "division": "ОГИБДД УМВД России по г. Москве",
    "date": "15.03.2015",
    "stag": "2010",
    "bdate": "05.07.1985",
    "num": "7712345678",
    "cat": "B",
    "srok": "15.03.2025"
  },
  "decis": [
    {
      "date": "20.06.2023",
      "fis_id": "188107810623001234",
      "comment": "Управление ТС в состоянии опьянения",
      "state": "ИСПОЛНЕНО",
      "srok": 18,
      "stateinfo": "Постановление исполнено полностью"
    }
  ],
  "status": 200,
  "found": true,
  "inquiry": {
    "price": 25,
    "balance": 15430,
    "credit": "0",
    "speed": 1.2,
    "attempts": 1
  }
}
```

#### Маппинг данных в нашу систему:
| Поле API | Поле системы | Описание |
|----------|--------------|----------|
| doc.division | issuedBy | Кем выдано ВУ |
| doc.date | issueDate | Дата выдачи |
| doc.stag | experienceSince | Стаж с года |
| doc.bdate | birthDate | Дата рождения |
| doc.num | licenseNumber | Номер ВУ |
| doc.cat | categories | Категории ТС |
| doc.srok | expiryDate | Срок действия |
| decis[] | suspensions | Массив лишений |

### Обработка ошибок и исключений

#### Типы ошибок:
1. **Сетевые ошибки** - таймауты, недоступность сервиса
2. **Ошибки API** - неверные параметры, недостаток баланса
3. **Ошибки данных** - некорректный формат ответа

#### Стратегии обработки:
- **Повторные попытки:** До 3 попыток с экспоненциальной задержкой
- **Graceful degradation:** Работа с кэшированными данными при недоступности API
- **Детальное логирование:** Все запросы и ошибки записываются в логи
- **Уведомления администратора:** Критические ошибки отправляются на email

## Пользовательские роли и права

### Доступ к функции интеграции

1. **СуперАдмин**
   - Настройка параметров API (токен, частота обновлений)
   - Просмотр статистики использования и логов
   - Управление балансом и контрактами с API-Cloud

2. **Админ компании**
   - Инициация проверки ВУ через API
   - Просмотр статуса последних обновлений
   - Получение уведомлений о проблемах с API

3. **Логист**
   - Автоматическое обновление данных при работе с ВУ
   - Просмотр статуса актуальности данных
   - Возможность запроса принудительного обновления

4. **Водитель**
   - Прозрачное обновление данных своего ВУ
   - Уведомления об изменениях в статусе ВУ
   - Просмотр даты последней проверки

### Настройки и конфигурация

**Системные параметры:**
- **API Token** - ключ доступа к API-Cloud
- **Update Frequency** - частота автоматических обновлений (по умолчанию: 7 дней)
- **Balance Threshold** - порог баланса для уведомлений (по умолчанию: 10000 руб.)
- **Retry Attempts** - количество повторных попыток (по умолчанию: 3)
- **Timeout** - таймаут запросов (по умолчанию: 30 сек.)

**Уведомления:**
- Низкий баланс API
- Ошибки интеграции
- Изменения в данных ВУ
- Новые лишения

## Интеграции и зависимости

**Связанные сервисы:**
- `api-cloud-service` - прокси для работы с внешним API
- `notification-service` - отправка уведомлений
- `drivers-license-service` - основной сервис ВУ
- `audit-service` - логирование операций

**Связанные интерфейсы:**
- TD-303-APIIntegration - интерфейс мониторинга интеграции
- Настройки API в административной панели
- Индикаторы актуальности данных в формах ВУ

## Мониторинг и аналитика

### Метрики производительности:
- Время ответа API (среднее, максимальное)
- Успешность запросов (%)
- Количество запросов за период
- Стоимость использования API

### Алерты и уведомления:
- Превышение лимита ошибок (>5% за час)
- Длительное время ответа API (>10 сек.)
- Критический баланс (<1000 руб.)
- Полная недоступность API (>5 мин.)

## Связанные документы

- [Модуль Drivers License](../drivers-license.md)
- [Управление ВУ](./management.md)
- [Система уведомлений](./notifications.md)
- [Настройки системы](./settings.md)
- [Personal Account](../../../personal-account.md) 