---
feature_id: drivers-license-api-integration
title: "Интеграция с API-Cloud"
description: "Интеграция с внешним сервисом API-Cloud для получения данных о ВУ"
acceptance_criteria:
  - "Автоматическое получение дополнительных данных ВУ при создании"
  - "Кэширование ответов API в базе данных"
  - "Периодическое обновление данных согласно настройкам"
  - "Мониторинг баланса API и отправка уведомлений"
  - "Корректная обработка ответов API"
linked_services:
  - api-cloud-service
  - notification-service
linked_designs:
  - TD-303-APIIntegration
full_description: |
  ### Цель
  Реализовать интеграцию с API-Cloud для автоматического получения данных о водительских удостоверениях.

  ### API Контракт
  Endpoint: https://api-cloud.ru/api/gibdd.php
  
  Параметры запроса:
  - type=driver (константа)
  - serianomer - Серия и номер ВУ (только цифры)
  - date - Дата выдачи (формат дд.мм.гггг)
  - token - API ключ

  ### Логика работы
  1. При добавлении/проверке ВУ:
     - Поиск в локальной базе по номеру и дате
     - Проверка актуальности записи согласно настройкам
     - Запрос к API при необходимости
  
  2. Кэширование данных:
     - Сохранение всех ответов API
     - Сохранение даты последнего обновления
     - Учет настроек частоты обновления

  3. Мониторинг API:
     - Отслеживание баланса
     - Уведомление на a.ivanov@cargonomica.com при балансе < 10000
     - Сохранение статистики запросов

  ### Структура ответа API
  ```json
  {
    "doc": {
      "division": "string",    // Кем выдано
      "date": "date",         // Дата выдачи
      "stag": "string",       // Стаж с
      "bdate": "date",        // Дата рождения
      "num": "string",        // Серия и номер
      "cat": "string",        // Категории ТС
      "srok": "date"          // Срок действия
    },
    "decis": [                // Информация о лишениях
      {
        "date": "date",       // Дата постановления
        "fis_id": "string",   // Номер постановления
        "comment": "string",   // Комментарий
        "state": "string",    // Состояние исполнения
        "srok": "number",     // Срок лишения
        "stateinfo": "string" // Расшифровка состояния
      }
    ],
    "status": "number",
    "found": "boolean",
    "inquiry": {
      "price": "number",      // Стоимость запроса
      "balance": "number",    // Текущий баланс
      "credit": "string",     // Кредитный лимит
      "speed": "number",      // Скорость запроса
      "attempts": "number"    // Количество попыток
    }
  }
  ```

  ### Обработка ошибок
  - Логирование всех запросов и ответов
  - Обработка сетевых ошибок
  - Обработка невалидных данных
  - Механизм повторных попыток 